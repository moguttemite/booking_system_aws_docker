# 讲师个人资料编辑功能

## 功能概述

这个功能允许讲师编辑和管理他们的个人资料信息，包括：

- 个人头像上传（支持自动压缩）
- 基本信息编辑（姓名、电话、自我介绍）
- 密码修改（跳转到专门页面）

## 图片上传功能

### 存储方式
- **存储位置**: `/public/imgs/` 目录
- **文件命名**: `profile_{用户ID}_{时间戳}_{随机字符串}.jpg`
- **访问方式**: 通过 `/imgs/{文件名}` URL 访问

### 图片处理
- **强制比例**: 自动处理为纵向3:2比例（800x1200px）
- **智能裁剪**: 保持图片比例并居中显示
- **质量优化**: 压缩质量设置为 85%
- **格式转换**: 统一转换为 JPG 格式
- **文件大小限制**: 最大 5MB
- **适用场景**: 讲座宣传海报、讲师全身照片

### 文件验证
- **类型检查**: 只允许图片文件（image/*）
- **大小检查**: 最大 5MB
- **格式支持**: JPG, PNG, GIF, BMP, WebP

## 组件结构

### ProfileEditModal.tsx
主要的个人资料编辑模态框组件，包含：

- **宣传图片上传区域**: 支持图片文件上传，实时预览，强制纵向3:2比例，适合讲座海报
- **基本信息编辑**: 姓名、电话、自我介绍字段
- **手机号验证**: 实时验证日本手机号格式（10位或11位）
- **安全设置**: 密码修改按钮，跳转到专门页面
- **数据验证**: 输入验证和错误处理

### 讲师信息展示区域
重新设计的讲师信息展示区域，包含：

- **真实数据展示**: 从数据库读取讲师资料（照片、姓名、电话、自我介绍）
- **简洁布局**: 左侧照片完整显示，右侧信息和操作按钮
- **标题设计**: "講師ページ - {姓名}さん" 格式，简洁明了
- **照片展示**: 200x300px容器，完整显示照片内容（objectFit: contain）
- **自我介绍**: 独立区域，带背景色和边框，最小高度80px
- **加载状态**: 显示资料加载进度
- **实时更新**: 资料编辑后立即更新显示

### 讲座权限控制
新增的讲座权限控制功能，包含：

- **单讲师讲座**: 讲师可以编辑讲座信息和时间安排
- **多讲师讲座**: 讲师只能编辑时间安排，不能编辑讲座信息
- **权限提示**: 多讲师讲座显示"管理者のみ編集可能"提示
- **编辑按钮**: 根据讲座类型动态显示/隐藏编辑按钮

### 预约安排查看功能
新增的预约安排查看功能，包含：

- **点击讲座名**: 点击讲座名字可查看预约安排
- **週間カレンダー表示**: 显示一周的预约状况
- **时间槽状态**: 显示每个时间槽的可用/已预约状态
- **周导航**: 可以切换到上一周/下一周查看
- **图例说明**: 清晰的颜色和符号说明

### 数据同步机制
新增的数据同步功能，包含：

- **实时同步**: 讲师资料更新时立即同步到所有相关讲座
- **头像同步**: 讲师头像变更时自动更新所有讲座的头像
- **介绍同步**: 讲师介绍变更时自动更新所有讲座的介绍
- **姓名同步**: 讲师姓名变更时自动更新所有讲座的讲师姓名
- **容错处理**: 同步失败不影响主要功能，记录错误日志

### 讲座创建优化
优化的讲座创建功能，包含：

- **真实讲师信息**: 使用从后端获取的真实讲师资料
- **讲师介绍**: 自动填充讲师的真实自我介绍
- **讲师头像**: 使用讲师的真实头像，而不是默认图片
- **数据一致性**: 确保讲座信息与讲师资料保持一致

### 功能特点

1. **响应式设计**: 适配不同屏幕尺寸
2. **实时预览**: 图片上传后立即显示预览
3. **强制比例**: 自动处理为纵向3:2比例（800x1200px）
4. **智能裁剪**: 保持图片比例并居中显示
5. **文件系统存储**: 图片保存到服务器文件系统
6. **用户友好**: 加载状态、错误提示、成功反馈
7. **表单验证**: 必填字段验证、手机号格式验证、密码强度检查
8. **真实数据展示**: 从数据库读取并显示讲师资料
9. **实时更新**: 资料编辑后立即更新页面显示
10. **权限控制**: 多讲师讲座只能由管理员编辑，讲师只能编辑时间安排
11. **数据一致性**: 讲座创建时自动使用真实的讲师信息
12. **数据同步**: 讲师资料变更时自动同步到所有相关讲座
13. **预约查看**: 点击讲座名字可查看预约安排和週間カレンダー

## API接口

### POST /api/teacher-profile
保存讲师个人资料

**请求体:**
```json
{
  "id": 1,
  "phone": "090-1234-5678",
  "bio": "自我介绍内容",
  "profile_image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..." // Base64图片数据
}
```

**响应:**
```json
{
  "success": true,
  "message": "プロフィールを更新しました",
  "profile": {
    "id": 1,
    "phone": "090-1234-5678",
    "bio": "自我介绍内容",
    "profile_image": "/imgs/profile_1_1703123456789_abc123.jpg",
    "created_at": "2025-01-15",
    "updated_at": "2025-01-15"
  }
}
```

### GET /api/teacher-profile?id={id}
获取指定讲师的个人资料

## 数据存储

### Mock数据
目前使用mock数据文件：`/public/mock/teacher_profiles.json`

### 图片文件
- **存储目录**: `/public/imgs/`
- **文件命名**: `profile_{用户ID}_{时间戳}_{随机字符串}.jpg`
- **访问URL**: `/imgs/{文件名}`

### 数据结构
```json
{
  "id": 1,
  "phone": "090-1234-5678",
  "bio": "自我介绍内容",
  "profile_image": "/imgs/profile_1_1703123456789_abc123.jpg",
  "created_at": "2025-01-15",
  "updated_at": "2025-01-15"
}
```

## 工具函数

### imageUtils.ts
包含以下图片处理函数：
- `compressImage()` - 通用图片压缩函数
- `compressPromotionalImage()` - 宣传图片压缩（800x1200px，85%质量）
- `compressAvatarImage()` - 头像图片压缩（400x400px，90%质量）
- `blobToBase64()` - 将Blob转换为Base64字符串
- `validateImageFile()` - 验证图片文件
- `formatFileSize()` - 格式化文件大小

## 使用方式

在讲师页面中点击"プロフィール編集"按钮即可打开编辑模态框。

### 图片上传流程
1. 用户选择图片文件
2. 前端验证文件类型和大小
3. 强制处理为纵向3:2比例（800x1200px，85%质量）
4. 转换为Base64格式
5. 发送到后端API
6. 后端保存为文件到 `/public/imgs/` 目录
7. 返回文件路径并更新数据库

### 手机号验证流程
1. 用户输入手机号
2. 实时验证格式（10位或11位数字）
3. 显示错误提示（如有问题）
4. 保存时自动格式化为 `xx-xxxx-xxxx` 或 `xxx-xxxx-xxxx` 格式
5. 发送到后端API保存

## 文件结构

```
frontend/
├── public/
│   ├── imgs/                    # 图片存储目录
│   │   └── .gitignore          # 忽略上传的图片文件
│   └── mock/
│       └── teacher_profiles.json # Mock数据
└── src/
         ├── components/teacher/
     │   └── ProfileEditModal.tsx # 编辑模态框组件
    ├── lib/
    │   └── imageUtils.ts        # 图片处理工具
    └── app/api/teacher-profile/
        └── route.ts             # API路由
```

## 待完善功能

1. **后端API集成**: 替换mock数据为真实数据库
2. **云存储**: 实现图片上传到云存储服务
3. **强制图片处理**: 已实现强制处理为纵向3:2比例
4. **多格式支持**: 支持更多图片格式
5. **权限控制**: 确保用户只能编辑自己的资料
6. **图片删除**: 实现旧图片的自动删除
